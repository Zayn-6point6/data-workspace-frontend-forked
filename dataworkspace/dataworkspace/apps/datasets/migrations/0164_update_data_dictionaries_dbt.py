# Generated by Django 4.2.7 on 2024-03-20 10:12

from django.db import migrations


def copy_source_table_field_def_dbt(apps, _):
    source_table_model = apps.get_model("datasets", "SourceTable")
    source_table_field_def_model = apps.get_model("datasets", "SourceTableFieldDefinition")
    for source_table in source_table_model.objects.filter(schema="dit").all():
        field_defs = source_table_field_def_model.objects.filter(source_table=source_table)
        if source_table_model.objects.filter(schema="dbt", table=source_table.table).exists:
            dbt_source_table = source_table_model.objects.get(schema="dbt", table=source_table.table)
            for field_definition in field_defs:
                field_definition.id = None
                field_definition.source_table = dbt_source_table
                field_definition.save()


class Migration(migrations.Migration):
    dependencies = [
        ("datasets", "0163_copy_dit_source_table_dbt"),
    ]

    operations = [
        migrations.RunPython(copy_source_table_field_def_dbt, reverse_code=migrations.RunPython.noop),
    ]
